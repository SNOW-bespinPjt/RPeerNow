<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.peernow360.mappers.IProjectMapper">

<!--    <insert id="createProject" parameterType="com.example.peernow360.dto.ProjectDto" useGeneratedKeys="true" keyProperty="no">-->
<!--        insert into PROJECT(user_id, title, detail, start_date, end_date, reg_date, mod_date)-->
<!--        values(#{user_id}, #{title}, #{detail}, #{start_date}, #{end_date}, now(), now())-->
<!--    </insert>-->

<!--    <insert id="createTeam" parameterType="com.example.peernow360.dto.TeamDto">-->

<!--        insert into TEAM(no, peer_id, role)-->
<!--        values(#{no}, #{peer_id}, #{role})-->

<!--    </insert>-->

    <insert id="createProject" parameterType="com.example.peernow360.dto.ProjectDto" useGeneratedKeys="true" keyProperty="no">
        insert into PROJECT(user_id, title, detail, start_date, end_date, reg_date, mod_date)
        values(#{user_id}, #{title}, #{detail}, #{start_date}, #{end_date}, now(), now())
    </insert>

    <insert id="createTeam" parameterType="com.example.peernow360.dto.TeamDto">
        insert into TEAM(peer_id, role, no, status)
        values(#{peer_id}, #{role}, #{no}, COALESCE(#{status}, 'WAIT'))
    </insert>


    <select id="projectDetail" parameterType="Integer" resultType="com.example.peernow360.dto.ProjectDto">
        select *
        from PROJECT
        where no = #{no}
    </select>

<!--    <update id="modifyProject" parameterType="com.example.peernow360.dto.ProjectDto">-->
<!--        update PROJECT-->
<!--        set title = #{title}, detail = #{detail}, start_date = #{start_date}, end_date = #{end_date}, mod_date = now()-->
<!--        where #{user_id} = (select peer_id from TEAM where role = 'PM' and no = #{no}) and no = #{no}-->

<!--    </update>-->

        <update id="modifyProject" parameterType="com.example.peernow360.dto.ProjectDto">
            update PROJECT p join TEAM t on p.no = t.no
            set title = #{title}, detail = #{detail}, start_date = #{start_date}, end_date = #{end_date}, mod_date = now()
            where t.role = 'PM' and peer_id = #{user_id} and p.no = #{no}
        </update>

    <update id="acceptProject" parameterType="HashMap">
        update TEAM
        set status = 'ACCEPT'
        where no = #{no} and peer_id = #{user_id}
    </update>

    <update id="declineProject" parameterType="HashMap">
        update TEAM
        set status = 'DECLINE'
        where no = #{no} and peer_id = #{user_id}
    </update>

    <delete id="deleteProject" parameterType="HashMap">
        delete p from PROJECT p
        join TEAM t on p.no = t.no
        where t.role = 'PM' and t.peer_id = #{user_id} and p.no = #{no}

    </delete>
    
</mapper>